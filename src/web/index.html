<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content, viewport-fit=cover">
    <title>Clay MUD Client</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="app">
        <!-- Toolbar -->
        <div id="toolbar">
            <div id="toolbar-left">
                <button id="menu-btn" class="toolbar-btn hamburger-btn" title="Menu"><svg width="18" height="18" viewBox="0 0 48.839 48.839"><path fill="#c0c0c0" d="M39.041,36.843c2.054,3.234,3.022,4.951,3.022,6.742c0,3.537-2.627,5.252-6.166,5.252c-1.56,0-2.567-0.002-5.112-1.326c0,0-1.649-1.509-5.508-1.354c-3.895-0.154-5.545,1.373-5.545,1.373c-2.545,1.323-3.516,1.309-5.074,1.309c-3.539,0-6.168-1.713-6.168-5.252c0-1.791,0.971-3.506,3.024-6.742c0,0,3.881-6.445,7.244-9.477c2.43-2.188,5.973-2.18,5.973-2.18h1.093v-0.001c0,0,3.698-0.009,5.976,2.181C35.059,30.51,39.041,36.844,39.041,36.843z M16.631,20.878c3.7,0,6.699-4.674,6.699-10.439S20.331,0,16.631,0S9.932,4.674,9.932,10.439S12.931,20.878,16.631,20.878z M10.211,30.988c2.727-1.259,3.349-5.723,1.388-9.971s-5.761-6.672-8.488-5.414s-3.348,5.723-1.388,9.971C3.684,29.822,7.484,32.245,10.211,30.988z M32.206,20.878c3.7,0,6.7-4.674,6.7-10.439S35.906,0,32.206,0s-6.699,4.674-6.699,10.439C25.507,16.204,28.506,20.878,32.206,20.878z M45.727,15.602c-2.728-1.259-6.527,1.165-8.488,5.414s-1.339,8.713,1.389,9.972c2.728,1.258,6.527-1.166,8.488-5.414S48.455,16.861,45.727,15.602z"/></svg></button>
                <div id="menu-dropdown" class="dropdown">
                    <div class="dropdown-item" data-action="actions">Actions</div>
                    <div class="dropdown-item" data-action="setup">Settings</div>
                    <div class="dropdown-item" data-action="web">Web</div>
                    <div class="dropdown-item" data-action="world-selector">Worlds</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="toggle-highlight">Toggle Highlight</div>
                    <div class="dropdown-item" data-action="toggle-tags">Toggle Tags</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item menu-change-password" data-action="change-password" style="display: none;">Change Password</div>
                    <div class="dropdown-item" data-action="resync">Resync</div>
                    <div class="dropdown-item" data-action="clay-server">Clay Server</div>
                    <div class="dropdown-divider menu-logout-divider" style="display: none;"></div>
                    <div class="dropdown-item menu-logout" data-action="logout" style="display: none;">Logout</div>
                </div>
                <span id="toolbar-title">Clay MUD Client</span>
            </div>
            <div id="toolbar-right">
                <span class="font-slider-label small">A</span>
                <div id="font-slider" class="font-slider" title="Font size">
                    <div class="slider-track"></div>
                    <div class="slider-handle" data-pos="2"></div>
                </div>
                <span class="font-slider-label large">A</span>
            </div>
        </div>

        <!-- Main output area -->
        <div id="output-container">
            <div id="output"></div>
        </div>

        <!-- Mobile toolbar (phones/tablets only) -->
        <div id="mobile-toolbar">
            <div id="mobile-toolbar-left">
                <button id="mobile-menu-btn" class="mobile-btn" title="Menu"><svg width="18" height="18" viewBox="0 0 48.839 48.839"><path fill="#c0c0c0" d="M39.041,36.843c2.054,3.234,3.022,4.951,3.022,6.742c0,3.537-2.627,5.252-6.166,5.252c-1.56,0-2.567-0.002-5.112-1.326c0,0-1.649-1.509-5.508-1.354c-3.895-0.154-5.545,1.373-5.545,1.373c-2.545,1.323-3.516,1.309-5.074,1.309c-3.539,0-6.168-1.713-6.168-5.252c0-1.791,0.971-3.506,3.024-6.742c0,0,3.881-6.445,7.244-9.477c2.43-2.188,5.973-2.18,5.973-2.18h1.093v-0.001c0,0,3.698-0.009,5.976,2.181C35.059,30.51,39.041,36.844,39.041,36.843z M16.631,20.878c3.7,0,6.699-4.674,6.699-10.439S20.331,0,16.631,0S9.932,4.674,9.932,10.439S12.931,20.878,16.631,20.878z M10.211,30.988c2.727-1.259,3.349-5.723,1.388-9.971s-5.761-6.672-8.488-5.414s-3.348,5.723-1.388,9.971C3.684,29.822,7.484,32.245,10.211,30.988z M32.206,20.878c3.7,0,6.7-4.674,6.7-10.439S35.906,0,32.206,0s-6.699,4.674-6.699,10.439C25.507,16.204,28.506,20.878,32.206,20.878z M45.727,15.602c-2.728-1.259-6.527,1.165-8.488,5.414s-1.339,8.713,1.389,9.972c2.728,1.258,6.527-1.166,8.488-5.414S48.455,16.861,45.727,15.602z"/></svg></button>
                <div id="mobile-menu-dropdown" class="dropdown">
                    <div class="dropdown-item" data-action="actions">Actions</div>
                    <div class="dropdown-item" data-action="setup">Settings</div>
                    <div class="dropdown-item" data-action="web">Web</div>
                    <div class="dropdown-item" data-action="world-selector">Worlds</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" data-action="toggle-highlight">Toggle Highlight</div>
                    <div class="dropdown-item" data-action="toggle-tags">Toggle Tags</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item menu-change-password" data-action="change-password" style="display: none;">Change Password</div>
                    <div class="dropdown-item" data-action="resync">Resync</div>
                    <div class="dropdown-item" data-action="clay-server">Clay Server</div>
                    <div class="dropdown-divider menu-logout-divider" style="display: none;"></div>
                    <div class="dropdown-item menu-logout" data-action="logout" style="display: none;">Logout</div>
                </div>
                <button id="mobile-pgup-btn" class="mobile-btn" title="Page Up">PgUp</button>
                <button id="mobile-pgdn-btn" class="mobile-btn" title="Page Down">PgDn</button>
                <span class="font-slider-label small">A</span>
                <div id="mobile-font-slider" class="font-slider" title="Font size">
                    <div class="slider-track"></div>
                    <div class="slider-handle" data-pos="2"></div>
                </div>
                <span class="font-slider-label large">A</span>
            </div>
            <div id="mobile-toolbar-right">
                <button id="mobile-up-btn" class="mobile-btn" title="Previous World">â–²</button>
                <button id="mobile-down-btn" class="mobile-btn" title="Next World">â–¼</button>
            </div>
        </div>

        <!-- Separator bar (like console) -->
        <div id="status-bar"><span id="status-indicator">___________</span><span id="connection-status">ðŸ”´</span><span id="world-name"></span><span id="activity-indicator"></span><span id="separator-fill"></span><span id="status-time"></span></div>

        <!-- Input area -->
        <div id="input-container">
            <span id="prompt"></span>
            <textarea id="input" autocomplete="off" autocapitalize="off" spellcheck="true" inputmode="text" autofocus rows="1"></textarea>
            <button id="send-btn">Send</button>
        </div>

        <!-- Authentication modal -->
        <div id="auth-modal" class="modal">
            <div class="modal-content">
                <h2>Authentication Required</h2>
                <p id="auth-prompt">Enter the WebSocket password to connect:</p>
                <div id="auth-username-row" style="display: none;">
                    <input type="text" id="auth-username" placeholder="Username" autocomplete="off">
                </div>
                <input type="password" id="auth-password" placeholder="Password" autocomplete="off">
                <div id="auth-error" class="error"></div>
                <button id="auth-submit">Connect</button>
            </div>
        </div>

        <!-- Connection status overlay -->
        <div id="connecting-overlay" class="overlay">
            <div class="overlay-content">
                <div class="spinner"></div>
                <p>Connecting...</p>
            </div>
        </div>

        <!-- Connection error modal -->
        <div id="connection-error-modal" class="modal">
            <div class="modal-content">
                <h2>Connection Failed</h2>
                <p id="connection-error-text">Unable to connect to the server after multiple attempts.</p>
                <div class="modal-buttons">
                    <button id="connection-retry-btn">Retry</button>
                    <button id="connection-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Filter popup (F4) -->
        <div id="filter-popup" class="filter-popup" style="display: none;">
            <div class="filter-popup-header">Find [Esc to close]</div>
            <div class="filter-popup-content">
                <span>Filter: </span>
                <input type="text" id="filter-input" autocomplete="off">
            </div>
        </div>

        <!-- Menu popup (/menu) -->
        <div id="menu-modal" class="modal">
            <div class="modal-content menu-modal-content">
                <h2>Menu</h2>
                <div id="menu-list" class="menu-list">
                    <div class="menu-item" data-command="/help">Help</div>
                    <div class="menu-item" data-command="/setup">Settings</div>
                    <div class="menu-item" data-command="/web">Web Settings</div>
                    <div class="menu-item" data-command="/actions">Actions</div>
                    <div class="menu-item" data-command="/worlds">World Selector</div>
                    <div class="menu-item" data-command="/connections">Connected Worlds</div>
                </div>
                <div class="menu-hint">â†‘â†“ select, Enter open, Esc close</div>
            </div>
        </div>

        <!-- Actions List popup (first window) -->
        <div id="actions-list-modal" class="modal">
            <div class="modal-content actions-list-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Actions</span>
                    <button id="actions-list-close-btn" class="popup-close">âœ•</button>
                </div>
                <div class="actions-filter">
                    <input type="text" id="action-filter" placeholder="Filter actions..." autocomplete="off">
                    <div id="action-world-filter" class="action-world-filter-indicator"></div>
                </div>
                <div id="actions-list" class="actions-list"></div>
                <div class="modal-buttons">
                    <button id="action-add-btn" class="action-btn">Add</button>
                    <button id="action-edit-btn" class="action-btn">Edit</button>
                    <button id="action-delete-btn" class="action-btn">Delete</button>
                    <button id="action-cancel-btn" class="action-btn">Ok</button>
                </div>
            </div>
        </div>

        <!-- Actions Editor popup (second window) -->
        <div id="actions-editor-modal" class="modal">
            <div class="modal-content actions-editor-modal-content">
                <div class="popup-header">
                    <span class="popup-title" id="action-editor-title">Edit Action</span>
                    <button id="actions-editor-close-btn" class="popup-close">âœ•</button>
                </div>
                <div class="action-field">
                    <label for="action-name">Name:</label>
                    <input type="text" id="action-name" autocomplete="off">
                </div>
                <div class="action-field">
                    <label for="action-world">World:</label>
                    <input type="text" id="action-world" autocomplete="off" placeholder="(empty = all worlds)">
                </div>
                <div class="action-field">
                    <label for="action-match-type">Match Type:</label>
                    <button id="action-match-type" class="toggle-btn">Regexp</button>
                </div>
                <div class="action-field">
                    <label for="action-pattern">Pattern:</label>
                    <input type="text" id="action-pattern" autocomplete="off" placeholder="(regex, empty = manual only)">
                </div>
                <div class="action-field">
                    <label for="action-enabled">Enabled:</label>
                    <button id="action-enabled" class="toggle-btn">Yes</button>
                </div>
                <div class="action-field">
                    <label for="action-command">Command:</label>
                    <textarea id="action-command" rows="3" autocomplete="off" placeholder="Commands (semicolon-separated)"></textarea>
                </div>
                <div id="action-error" class="error"></div>
                <div class="modal-buttons">
                    <button id="action-save-btn">Save</button>
                    <button id="action-editor-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Action Delete Confirmation popup -->
        <div id="action-confirm-modal" class="modal">
            <div class="modal-content action-confirm-modal-content">
                <p id="action-confirm-text">Delete this action?</p>
                <div class="modal-buttons">
                    <button id="action-confirm-yes-btn">Yes</button>
                    <button id="action-confirm-no-btn">No</button>
                </div>
            </div>
        </div>

        <!-- Worlds list popup (/connections or /l) -->
        <div id="worlds-modal" class="modal">
            <div class="modal-content worlds-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Connected Worlds</span>
                    <button id="worlds-list-close-btn" class="popup-close">âœ•</button>
                </div>
                <div id="worlds-table-container">
                    <table id="worlds-table">
                        <thead>
                            <tr>
                                <th>World</th>
                                <th>Unseen</th>
                                <th>Send/Recv</th>
                                <th>KeepAlive</th>
                                <th>Last/Next</th>
                            </tr>
                        </thead>
                        <tbody id="worlds-table-body"></tbody>
                    </table>
                </div>
                <div class="modal-buttons">
                    <button id="worlds-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- World selector popup (/worlds) -->
        <div id="world-selector-modal" class="modal">
            <div class="modal-content world-selector-modal-content">
                <h2>Worlds</h2>
                <div class="world-selector-filter">
                    <input type="text" id="world-filter" placeholder="Filter worlds..." autocomplete="off">
                </div>
                <div id="world-selector-table-container">
                    <table id="world-selector-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>World</th>
                                <th class="desktop-only">Hostname</th>
                                <th class="desktop-only">Port</th>
                                <th class="desktop-only">User</th>
                                <th class="mobile-only">Address</th>
                            </tr>
                        </thead>
                        <tbody id="world-selector-table-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer-split">
                    <div class="modal-footer-left">
                        <span class="toggle-label">Connected</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="world-selector-only-connected">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="modal-buttons">
                        <button id="world-add-btn">Add</button>
                        <button id="world-edit-btn">Edit</button>
                        <button id="world-selector-cancel-btn">Close</button>
                        <button id="world-connect-btn">Connect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- World Delete Confirmation popup -->
        <div id="world-confirm-modal" class="modal">
            <div class="modal-content action-confirm-modal-content">
                <p id="world-confirm-text">Delete this world?</p>
                <div class="modal-buttons">
                    <button id="world-confirm-yes-btn">Yes</button>
                    <button id="world-confirm-no-btn">No</button>
                </div>
            </div>
        </div>

        <!-- World Editor popup (/worlds -e) -->
        <div id="world-editor-modal" class="modal">
            <div class="modal-content world-editor-modal-content">
                <div class="popup-header">
                    <span class="popup-title" id="world-editor-title">Edit World</span>
                    <button id="world-edit-close-btn" class="popup-close">âœ•</button>
                </div>
                <div class="popup-body">
                    <div class="setting-row">
                        <span class="setting-label">Name</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-name" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Hostname</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-hostname" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Port</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-port" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">User</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-user" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Password</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-password" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Use SSL</span>
                        <div class="setting-value">
                            <div id="world-edit-ssl-toggle" class="toggle"></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Auto Login</span>
                        <div class="setting-value">
                            <select id="world-edit-auto-login-select" class="form-select">
                                <option value="Connect">Connect</option>
                                <option value="Prompt">Prompt</option>
                                <option value="MOO_prompt">MOO_prompt</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Keep Alive</span>
                        <div class="setting-value">
                            <select id="world-edit-keep-alive-select" class="form-select">
                                <option value="NOP">NOP</option>
                                <option value="Custom">Custom</option>
                                <option value="Generic">Generic</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row" id="world-edit-keep-alive-cmd-field">
                        <span class="setting-label">Keep Alive Cmd</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-keep-alive-cmd" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Encoding</span>
                        <div class="setting-value">
                            <select id="world-edit-encoding-select" class="form-select">
                                <option value="utf8">UTF-8</option>
                                <option value="latin1">Latin1</option>
                                <option value="fansi">Fansi</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Logging</span>
                        <div class="setting-value">
                            <div id="world-edit-logging-toggle" class="toggle"></div>
                        </div>
                    </div>
                </div>
                <div class="popup-footer">
                    <button id="world-edit-delete-btn" class="btn btn-danger">Delete</button>
                    <button id="world-edit-cancel-btn" class="btn">Cancel</button>
                    <button id="world-edit-save-btn" class="btn">Save</button>
                    <button id="world-edit-connect-btn" class="btn btn-primary">Connect</button>
                </div>
            </div>
        </div>

        <!-- Setup popup (/setup) -->
        <div id="setup-modal" class="modal">
            <div class="modal-content setup-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Settings</span>
                    <button id="setup-close-btn" class="popup-close">âœ•</button>
                </div>
                <div class="popup-body">
                    <div class="setting-row">
                        <span class="setting-label">World switching</span>
                        <div class="setting-value">
                            <select id="setup-world-switch-select" class="form-select">
                                <option value="Unseen First">Unseen First</option>
                                <option value="Alphabetical">Alphabetical</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Theme</span>
                        <div class="setting-value">
                            <select id="setup-theme-select" class="form-select">
                                <option value="Dark">Dark</option>
                                <option value="Light">Light</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Color Offset</span>
                        <div class="setting-value">
                            <div class="stepper">
                                <button id="setup-color-offset-minus" class="stepper-btn">âˆ’</button>
                                <span id="setup-color-offset-value" class="stepper-value">OFF</span>
                                <button id="setup-color-offset-plus" class="stepper-btn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-two-column">
                        <div class="settings-column">
                            <div class="setting-row">
                                <span class="setting-label">More mode</span>
                                <div class="setting-value">
                                    <div id="setup-more-mode-toggle" class="toggle"></div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Show tags</span>
                                <div class="setting-value">
                                    <div id="setup-show-tags-toggle" class="toggle"></div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-column">
                            <div class="setting-row">
                                <span class="setting-label">ANSI Music</span>
                                <div class="setting-value">
                                    <div id="setup-ansi-music-toggle" class="toggle"></div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">TLS Proxy</span>
                                <div class="setting-value">
                                    <div id="setup-tls-proxy-toggle" class="toggle"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Input height</span>
                        <div class="setting-value">
                            <div class="stepper">
                                <button id="setup-height-minus" class="stepper-btn">âˆ’</button>
                                <span id="setup-input-height-value" class="stepper-value">3</span>
                                <button id="setup-height-plus" class="stepper-btn">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="popup-footer">
                    <button id="setup-cancel-btn" class="btn">Cancel</button>
                    <button id="setup-save-btn" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Web Settings popup (/web) -->
        <div id="web-modal" class="modal">
            <div class="modal-content web-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Web Settings</span>
                    <button id="web-close-btn" class="popup-close">âœ•</button>
                </div>
                <div class="web-settings-form">
                    <div class="web-field">
                        <label>Protocol:</label>
                        <button id="web-protocol-btn" class="toggle-btn">Non-Secure</button>
                    </div>
                    <div class="web-field">
                        <label id="http-label">HTTP enabled:</label>
                        <button id="web-http-enabled-btn" class="toggle-btn">off</button>
                    </div>
                    <div class="web-field">
                        <label id="http-port-label">HTTP port:</label>
                        <input type="text" id="web-http-port" autocomplete="off" class="web-input">
                    </div>
                    <div class="web-field">
                        <label id="ws-label">WS enabled:</label>
                        <button id="web-ws-enabled-btn" class="toggle-btn">off</button>
                    </div>
                    <div class="web-field">
                        <label id="ws-port-label">WS port:</label>
                        <input type="text" id="web-ws-port" autocomplete="off" class="web-input">
                    </div>
                    <div class="web-field">
                        <label>Allow List:</label>
                        <input type="text" id="web-allow-list" autocomplete="off" class="web-input" placeholder="localhost, 192.168.*">
                    </div>
                    <div class="web-field tls-field" id="tls-cert-field" style="display: none;">
                        <label>TLS cert file:</label>
                        <input type="text" id="web-cert-file" autocomplete="off" class="web-input" placeholder="/path/to/cert.pem">
                    </div>
                    <div class="web-field tls-field" id="tls-key-field" style="display: none;">
                        <label>TLS key file:</label>
                        <input type="text" id="web-key-file" autocomplete="off" class="web-input" placeholder="/path/to/key.pem">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="web-cancel-btn">Cancel</button>
                    <button id="web-save-btn" class="btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Password Change modal (multiuser mode only) -->
        <div id="password-modal" class="modal">
            <div class="modal-content">
                <h2>Change Password</h2>
                <div class="password-field">
                    <label for="password-old">Current Password:</label>
                    <input type="password" id="password-old" autocomplete="off">
                </div>
                <div class="password-field">
                    <label for="password-new">New Password:</label>
                    <input type="password" id="password-new" autocomplete="off">
                </div>
                <div class="password-field">
                    <label for="password-confirm">Confirm Password:</label>
                    <input type="password" id="password-confirm" autocomplete="off">
                </div>
                <div id="password-error" class="error"></div>
                <div class="modal-buttons">
                    <button id="password-cancel-btn">Cancel</button>
                    <button id="password-save-btn" class="btn-primary">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket configuration injected by server
        window.WS_PORT = {{WS_PORT}};
        window.WS_PROTOCOL = '{{WS_PROTOCOL}}';
    </script>
    <script src="/app.js"></script>
</body>
</html>
