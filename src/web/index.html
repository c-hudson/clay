<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content, viewport-fit=cover">
    <title>Clay MUD Client</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <style id="theme-vars">:root { {{THEME_CSS_VARS}} }</style>
</head>
<body>
    <div id="app">
        <!-- Main output area -->
        <div id="output-container">
            <div id="output"></div>
        </div>

        <!-- Status bar -->
        <div id="status-bar">
            <div class="status-btn status-menu-btn" id="menu-btn" title="Menu">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect y="2" width="16" height="1.5" rx="0.75" fill="currentColor"/><rect y="7.25" width="16" height="1.5" rx="0.75" fill="currentColor"/><rect y="12.5" width="16" height="1.5" rx="0.75" fill="currentColor"/></svg>
            </div>
            <div class="status-item">
                <div class="status-dot" id="status-dot"></div>
                <span class="status-world" id="world-name"></span>
            </div>
            <div class="status-more" id="status-more" style="display:none"></div>
            <div class="status-spacer"></div>
            <div class="status-activity" id="activity-indicator" style="display:none">
                <span class="activity-label">ACT</span>
                <span class="activity-count" id="activity-count"></span>
            </div>
            <div class="font-slider-group status-font-slider">
                <span class="font-slider-label">A</span>
                <input type="range" class="font-slider" id="font-slider" min="9" max="20" value="14" title="Font size">
                <span class="font-slider-val" id="font-slider-val">14</span>
            </div>
            <div class="status-time" id="status-time"></div>
        </div>

        <!-- Mobile navigation bar -->
        <div id="nav-bar">
            <div class="nav-btn nav-menu-btn" id="nav-menu-btn" title="Menu">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect y="2" width="16" height="1.5" rx="0.75" fill="currentColor"/><rect y="7.25" width="16" height="1.5" rx="0.75" fill="currentColor"/><rect y="12.5" width="16" height="1.5" rx="0.75" fill="currentColor"/></svg>
            </div>
            <button class="nav-btn" id="nav-pgup-btn">PgUp</button>
            <button class="nav-btn" id="nav-pgdn-btn">PgDn</button>
            <div class="font-slider-group nav-font-slider">
                <span class="font-slider-label">A</span>
                <input type="range" class="font-slider" id="nav-font-slider" min="9" max="20" value="14" title="Font size">
                <span class="font-slider-val" id="nav-font-slider-val">14</span>
            </div>
            <div class="nav-spacer"></div>
            <button class="nav-btn" id="nav-up-btn" title="Previous World">&#9650;</button>
            <button class="nav-btn" id="nav-down-btn" title="Next World">&#9660;</button>
        </div>

        <!-- Input area -->
        <div id="input-container">
            <span id="prompt"></span>
            <textarea id="input" autocomplete="off" autocapitalize="off" spellcheck="true" inputmode="text" autofocus rows="1"></textarea>
            <button id="send-btn">Send</button>
        </div>

        <!-- Menu dropdown (unified, opens upward from status/nav bar) -->
        <div id="menu-dropdown" class="menu-dropdown">
            <div class="menu-item" data-action="world-selector">World Selector<span class="shortcut">/worlds</span></div>
            <div class="menu-item" data-action="actions">Actions<span class="shortcut">/actions</span></div>
            <div class="menu-sep"></div>
            <div class="menu-item" data-action="setup">Setup<span class="shortcut">/setup</span></div>
            <div class="menu-item" data-action="web">Web Settings<span class="shortcut">/web</span></div>
            <div class="menu-sep"></div>
            <div class="menu-item" data-action="toggle-tags">Toggle Tags<span class="shortcut">F2</span></div>
            <div class="menu-item" data-action="filter">Filter<span class="shortcut">F4</span></div>
            <div class="menu-sep"></div>
            <div class="menu-item menu-change-password" data-action="change-password" style="display: none;">Change Password</div>
            <div class="menu-item" data-action="resync">Resync</div>
            <div class="menu-item menu-clay-server" data-action="clay-server" style="display: none;">Clay Server</div>
            <div class="menu-sep menu-logout-divider" style="display: none;"></div>
            <div class="menu-item menu-logout" data-action="logout" style="display: none;">Logout</div>
        </div>

        <!-- Authentication modal -->
        <div id="auth-modal" class="modal">
            <div class="modal-content">
                <h2>Authentication Required</h2>
                <p id="auth-prompt">Enter the WebSocket password to connect:</p>
                <div id="auth-username-row" style="display: none;">
                    <input type="text" id="auth-username" placeholder="Username" autocomplete="off">
                </div>
                <input type="password" id="auth-password" placeholder="Password" autocomplete="off">
                <div id="auth-error" class="error"></div>
                <button id="auth-submit">Connect</button>
            </div>
        </div>

        <!-- Connection status overlay -->
        <div id="connecting-overlay" class="overlay">
            <div class="overlay-content">
                <div class="spinner"></div>
                <p>Connecting...</p>
            </div>
        </div>

        <!-- Connection error modal -->
        <div id="connection-error-modal" class="modal">
            <div class="modal-content">
                <h2>Connection Failed</h2>
                <p id="connection-error-text">Unable to connect to the server after multiple attempts.</p>
                <div class="modal-buttons">
                    <button id="connection-retry-btn">Retry</button>
                    <button id="connection-cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Reconnect modal (shown when send fails due to disconnection) -->
        <div id="reconnect-modal" class="modal">
            <div class="modal-content">
                <h2>Connection Lost</h2>
                <p id="reconnect-text">Unable to send command. The connection to the server was lost.</p>
                <div class="modal-buttons">
                    <button id="reconnect-cancel-btn">Cancel</button>
                    <button id="reconnect-btn" class="btn-primary">Reconnect</button>
                </div>
            </div>
        </div>

        <!-- Filter popup (F4) -->
        <div id="filter-popup" class="filter-popup" style="display: none;">
            <div class="filter-popup-header">Find [Esc to close]</div>
            <div class="filter-popup-content">
                <span>Filter: </span>
                <input type="text" id="filter-input" autocomplete="off">
            </div>
        </div>

        <!-- Menu popup (/menu) -->
        <div id="menu-modal" class="modal">
            <div class="modal-content menu-modal-content">
                <h2>Menu</h2>
                <div id="menu-list" class="menu-list">
                    <div class="menu-item" data-command="/help">Help</div>
                    <div class="menu-item" data-command="/setup">Settings</div>
                    <div class="menu-item" data-command="/web">Web Settings</div>
                    <div class="menu-item" data-command="/actions">Actions</div>
                    <div class="menu-item" data-command="/worlds">World Selector</div>
                    <div class="menu-item" data-command="/connections">Connected Worlds</div>
                </div>
                <div class="menu-hint">select, Enter open, Esc close</div>
            </div>
        </div>

        <!-- Actions List popup (first window) -->
        <div id="actions-list-modal" class="modal">
            <div class="modal-content actions-list-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Actions</span>
                    <button id="actions-list-close-btn" class="popup-close">&#10005;</button>
                </div>
                <div class="actions-filter">
                    <input type="text" id="action-filter" placeholder="Filter actions..." autocomplete="off">
                    <div id="action-world-filter" class="action-world-filter-indicator"></div>
                </div>
                <div id="actions-list" class="actions-list"></div>
                <div class="modal-buttons">
                    <button id="action-delete-btn" class="action-btn btn-danger">Delete</button>
                    <button id="action-add-btn" class="action-btn">Add</button>
                    <button id="action-edit-btn" class="action-btn">Edit</button>
                    <button id="action-cancel-btn" class="action-btn btn-primary">Ok</button>
                </div>
            </div>
        </div>

        <!-- Actions Editor popup (second window) -->
        <div id="actions-editor-modal" class="modal">
            <div class="modal-content actions-editor-modal-content">
                <div class="popup-header">
                    <span class="popup-title" id="action-editor-title">Edit Action</span>
                    <button id="actions-editor-close-btn" class="popup-close">&#10005;</button>
                </div>
                <div class="action-field">
                    <label for="action-name">Name:</label>
                    <input type="text" id="action-name" autocomplete="off">
                </div>
                <div class="action-field">
                    <label for="action-world">World:</label>
                    <input type="text" id="action-world" autocomplete="off" placeholder="(empty = all worlds)">
                </div>
                <div class="action-field">
                    <label for="action-match-type">Match Type:</label>
                    <select id="action-match-type" class="form-select">
                        <option value="regexp">Regexp</option>
                        <option value="wildcard">Wildcard</option>
                    </select>
                </div>
                <div class="action-field">
                    <label for="action-pattern">Pattern:</label>
                    <input type="text" id="action-pattern" autocomplete="off" placeholder="(regex, empty = manual only)">
                </div>
                <div class="action-field">
                    <label for="action-enabled">Enabled:</label>
                    <select id="action-enabled" class="form-select">
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="action-field">
                    <label for="action-startup">Startup:</label>
                    <select id="action-startup" class="form-select">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="action-field">
                    <label for="action-command">Command:</label>
                    <textarea id="action-command" rows="3" autocomplete="off" placeholder="Commands (semicolon-separated)"></textarea>
                </div>
                <div id="action-error" class="error"></div>
                <div class="modal-buttons">
                    <button id="action-editor-cancel-btn">Cancel</button>
                    <button id="action-save-btn" class="btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Action Delete Confirmation popup -->
        <div id="action-confirm-modal" class="modal">
            <div class="modal-content action-confirm-modal-content">
                <p id="action-confirm-text">Delete this action?</p>
                <div class="modal-buttons">
                    <button id="action-confirm-yes-btn">Yes</button>
                    <button id="action-confirm-no-btn">No</button>
                </div>
            </div>
        </div>

        <!-- Worlds list popup (/connections or /l) -->
        <div id="worlds-modal" class="modal">
            <div class="modal-content worlds-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Connected Worlds</span>
                    <button id="worlds-list-close-btn" class="popup-close">&#10005;</button>
                </div>
                <div id="worlds-table-container">
                    <table id="worlds-table">
                        <thead>
                            <tr>
                                <th>World</th>
                                <th>Unseen</th>
                                <th>Last</th>
                                <th>KA</th>
                                <th>Buffer</th>
                            </tr>
                        </thead>
                        <tbody id="worlds-table-body"></tbody>
                    </table>
                </div>
                <div class="modal-buttons">
                    <button id="worlds-close-btn">Close</button>
                </div>
            </div>
        </div>

        <!-- World selector popup (/worlds) -->
        <div id="world-selector-modal" class="modal">
            <div class="modal-content world-selector-modal-content">
                <h2>Worlds</h2>
                <div class="world-selector-filter">
                    <input type="text" id="world-filter" placeholder="Filter worlds..." autocomplete="off">
                </div>
                <div id="world-selector-table-container">
                    <table id="world-selector-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>World</th>
                                <th class="desktop-only">Hostname</th>
                                <th class="desktop-only">Port</th>
                                <th class="desktop-only">User</th>
                                <th class="mobile-only">Address</th>
                            </tr>
                        </thead>
                        <tbody id="world-selector-table-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer-split">
                    <div class="modal-footer-left">
                        <span class="toggle-label">Connected</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="world-selector-only-connected">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="modal-buttons">
                        <button id="world-add-btn">Add</button>
                        <button id="world-edit-btn">Edit</button>
                        <button id="world-selector-cancel-btn">Close</button>
                        <button id="world-connect-btn" class="btn-primary">Connect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- World Delete Confirmation popup -->
        <div id="world-confirm-modal" class="modal">
            <div class="modal-content action-confirm-modal-content">
                <p id="world-confirm-text">Delete this world?</p>
                <div class="modal-buttons">
                    <button id="world-confirm-yes-btn">Yes</button>
                    <button id="world-confirm-no-btn">No</button>
                </div>
            </div>
        </div>

        <!-- World Editor popup (/worlds -e) -->
        <div id="world-editor-modal" class="modal">
            <div class="modal-content world-editor-modal-content">
                <div class="popup-header">
                    <span class="popup-title" id="world-editor-title">Edit World</span>
                    <button id="world-edit-close-btn" class="popup-close">&#10005;</button>
                </div>
                <div class="popup-body">
                    <div class="setting-row">
                        <span class="setting-label">Name</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-name" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Hostname</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-hostname" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Port</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-port" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">User</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-user" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Password</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-password" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Use SSL</span>
                        <div class="setting-value">
                            <div id="world-edit-ssl-toggle" class="toggle"></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Auto Login</span>
                        <div class="setting-value">
                            <select id="world-edit-auto-login-select" class="form-select">
                                <option value="Connect">Connect</option>
                                <option value="Prompt">Prompt</option>
                                <option value="MOO_prompt">MOO_prompt</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Keep Alive</span>
                        <div class="setting-value">
                            <select id="world-edit-keep-alive-select" class="form-select">
                                <option value="NOP">NOP</option>
                                <option value="Custom">Custom</option>
                                <option value="Generic">Generic</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row" id="world-edit-keep-alive-cmd-field">
                        <span class="setting-label">Keep Alive Cmd</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-keep-alive-cmd" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Encoding</span>
                        <div class="setting-value">
                            <select id="world-edit-encoding-select" class="form-select">
                                <option value="utf8">UTF-8</option>
                                <option value="latin1">Latin1</option>
                                <option value="fansi">Fansi</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Logging</span>
                        <div class="setting-value">
                            <div id="world-edit-logging-toggle" class="toggle"></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">GMCP Packages</span>
                        <div class="setting-value">
                            <input type="text" id="world-edit-gmcp-packages" class="editor-input" autocomplete="off">
                        </div>
                    </div>
                </div>
                <div class="popup-footer">
                    <button id="world-edit-delete-btn" class="btn btn-danger">Delete</button>
                    <button id="world-edit-cancel-btn" class="btn">Cancel</button>
                    <button id="world-edit-save-btn" class="btn">Save</button>
                    <button id="world-edit-connect-btn" class="btn btn-primary">Connect</button>
                </div>
            </div>
        </div>

        <!-- Setup popup (/setup) -->
        <div id="setup-modal" class="modal">
            <div class="modal-content setup-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Settings</span>
                    <button id="setup-close-btn" class="popup-close">&#10005;</button>
                </div>
                <div class="popup-body">
                    <div class="setting-row">
                        <span class="setting-label">World switching</span>
                        <div class="setting-value">
                            <select id="setup-world-switch-select" class="form-select">
                                <option value="Unseen First">Unseen First</option>
                                <option value="Alphabetical">Alphabetical</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Theme</span>
                        <div class="setting-value">
                            <select id="setup-theme-select" class="form-select">
                                <option value="Dark">Dark</option>
                                <option value="Light">Light</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Color Offset</span>
                        <div class="setting-value">
                            <div class="stepper">
                                <button id="setup-color-offset-minus" class="stepper-btn">&#8722;</button>
                                <span id="setup-color-offset-value" class="stepper-value">OFF</span>
                                <button id="setup-color-offset-plus" class="stepper-btn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span class="setting-label">Input height</span>
                        <div class="setting-value">
                            <div class="stepper">
                                <button id="setup-height-minus" class="stepper-btn">&#8722;</button>
                                <span id="setup-input-height-value" class="stepper-value">3</span>
                                <button id="setup-height-plus" class="stepper-btn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-two-column">
                        <div class="settings-column">
                            <div class="setting-row">
                                <span class="setting-label">More mode</span>
                                <div class="setting-value">
                                    <div id="setup-more-mode-toggle" class="toggle"></div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">TLS Proxy</span>
                                <div class="setting-value">
                                    <div id="setup-tls-proxy-toggle" class="toggle"></div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-column">
                            <div class="setting-row">
                                <span class="setting-label">ANSI Music</span>
                                <div class="setting-value">
                                    <div id="setup-ansi-music-toggle" class="toggle"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="popup-footer">
                    <button id="setup-cancel-btn" class="btn">Cancel</button>
                    <button id="setup-save-btn" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Web Settings popup (/web) -->
        <div id="web-modal" class="modal">
            <div class="modal-content web-modal-content">
                <div class="popup-header">
                    <span class="popup-title">Web Settings</span>
                    <button id="web-close-btn" class="popup-close">&#10005;</button>
                </div>
                <div class="web-settings-form">
                    <div class="web-field">
                        <label>Protocol</label>
                        <select id="web-protocol-select" class="form-select">
                            <option value="non-secure">Non-Secure</option>
                            <option value="secure">Secure</option>
                        </select>
                    </div>
                    <div class="web-field">
                        <label id="http-label">HTTP enabled</label>
                        <select id="web-http-enabled-select" class="form-select">
                            <option value="off">off</option>
                            <option value="on">on</option>
                        </select>
                    </div>
                    <div class="web-field">
                        <label id="http-port-label">HTTP port</label>
                        <input type="text" id="web-http-port" autocomplete="off" class="web-input">
                    </div>
                    <div class="web-field">
                        <label id="ws-label">WS enabled</label>
                        <select id="web-ws-enabled-select" class="form-select">
                            <option value="off">off</option>
                            <option value="on">on</option>
                        </select>
                    </div>
                    <div class="web-field">
                        <label id="ws-port-label">WS port</label>
                        <input type="text" id="web-ws-port" autocomplete="off" class="web-input">
                    </div>
                    <div class="web-field">
                        <label>Allow List</label>
                        <input type="text" id="web-allow-list" autocomplete="off" class="web-input" placeholder="localhost, 192.168.*">
                    </div>
                    <div class="web-field tls-field" id="tls-cert-field" style="display: none;">
                        <label>TLS cert file</label>
                        <input type="text" id="web-cert-file" autocomplete="off" class="web-input" placeholder="/path/to/cert.pem">
                    </div>
                    <div class="web-field tls-field" id="tls-key-field" style="display: none;">
                        <label>TLS key file</label>
                        <input type="text" id="web-key-file" autocomplete="off" class="web-input" placeholder="/path/to/key.pem">
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="web-cancel-btn">Cancel</button>
                    <button id="web-save-btn" class="btn-primary">Save</button>
                </div>
            </div>
        </div>

        <!-- Device Mode selector (long-press hamburger menu) -->
        <div id="device-mode-modal" class="modal">
            <div class="modal-content menu-modal-content">
                <h2>Device Mode</h2>
                <div id="device-mode-list" class="menu-list">
                    <div class="menu-item" data-mode="auto">Auto</div>
                    <div class="menu-item" data-mode="phone">Phone</div>
                    <div class="menu-item" data-mode="tablet">Tablet</div>
                    <div class="menu-item" data-mode="desktop">Desktop</div>
                </div>
                <div class="menu-hint">Hold menu button 2s to open</div>
            </div>
        </div>

        <!-- Password Change modal (multiuser mode only) -->
        <div id="password-modal" class="modal">
            <div class="modal-content">
                <h2>Change Password</h2>
                <div class="password-field">
                    <label for="password-old">Current Password:</label>
                    <input type="password" id="password-old" autocomplete="off">
                </div>
                <div class="password-field">
                    <label for="password-new">New Password:</label>
                    <input type="password" id="password-new" autocomplete="off">
                </div>
                <div class="password-field">
                    <label for="password-confirm">Confirm Password:</label>
                    <input type="password" id="password-confirm" autocomplete="off">
                </div>
                <div id="password-error" class="error"></div>
                <div class="modal-buttons">
                    <button id="password-cancel-btn">Cancel</button>
                    <button id="password-save-btn" class="btn-primary">Change Password</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket configuration injected by server
        window.WS_HOST = '{{WS_HOST}}';
        window.WS_PORT = {{WS_PORT}};
        window.WS_PROTOCOL = '{{WS_PROTOCOL}}';
    </script>
    <script src="/app.js"></script>
</body>
</html>
